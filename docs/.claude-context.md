# Claude Context - Prompt Valley Database Setup

## Project Overview
- **Project**: PromptValley - A prompt management SaaS
- **Stack**: React/TypeScript + Supabase (PostgreSQL)
- **CMS**: Directus (connected to Supabase DB)

## Database Migration History

### Fresh Clean Migration Setup (Jan 31, 2025)
Created 12 self-contained migrations (each table in own file with all RLS, indexes, triggers, functions):

1. **20250131000001_utilities.sql** - Shared `set_updated_at()` function
2. **20250131000002_enums.sql** - `tier` (free, pro), `model_capability` (text, image, video, code)
3. **20250131000003_users.sql** - Synced from auth.users
4. **20250131000004_ai_providers.sql** - OpenAI, Anthropic, Google, etc.
5. **20250131000005_ai_models.sql** - GPT-4, Claude, Gemini models (id is TEXT PRIMARY KEY, NOT model_id)
6. **20250131000006_categories.sql** - Hierarchical with cycle prevention
7. **20250131000007_tags.sql** - Simple tags
8. **20250131000008_prompts.sql** - Main content table with images as TEXT[]
9. **20250131000009_prompt_tags.sql** - Junction table
10. **20250131000010_prompt_models.sql** - Junction table (model_id references ai_models.id)
11. **20250131000011_user_favorites.sql** - User saved prompts
12. **20250131000012_stripe_integration.sql** - Wrappers extension + stripe schema

### Fields REMOVED from Schema
- **All tables**: display_name, description, is_active, sort_order
- **ai_models**: model_version, is_featured, release_date, deprecation_date
- **categories**: icon, color
- **tags**: usage_count, is_featured
- **prompts**: meta_title, meta_description
- **prompt_models**: recommended_settings, is_primary
- **user_favorites**: notes
- **Removed table**: user_subscriptions (using Stripe wrapper instead)

### Security Fixes Applied
1. **Function Security**: Added `SECURITY DEFINER` and `SET search_path = ''` to all functions
2. **RLS Performance**: Wrapped all `auth.uid()` and `auth.jwt()` in subselects: `(SELECT auth.uid())`
3. **Policy Structure**: Split `FOR ALL` policies into separate INSERT/UPDATE/DELETE

## Current Issues & Solutions

### Issue: Directus CMS Permissions
**Problem**: Directus (using Supabase service_role key) gets FORBIDDEN errors on `prompt_tags` and `prompt_models`

**Root Cause**: RLS policies check for `auth.jwt() ->> 'role' = 'admin'` but service_role doesn't have this claim

**Solution Applied** (Migration 20251201030609):
```sql
-- Added explicit service_role bypass policies
CREATE POLICY "Service role bypasses RLS on prompt_tags"
  ON prompt_tags AS PERMISSIVE FOR ALL TO service_role
  USING (true) WITH CHECK (true);

CREATE POLICY "Service role bypasses RLS on prompt_models"
  ON prompt_models AS PERMISSIVE FOR ALL TO service_role
  USING (true) WITH CHECK (true);
```

### Directus Setup Notes
- Directus creates its own system tables (moved to separate schema to avoid pollution)
- Content team manages: ai_providers, ai_models, categories, tags, prompts
- Image uploads: Using TEXT fields with URLs (upload to Supabase Storage, paste URL)
- File/Image interfaces unavailable when Directus is in separate schema

## Migration Best Practices (IMPORTANT!)
1. **NO MORE DB RESETS** - Only incremental migrations via `npx supabase db push`
2. **Always use current timestamp** for new migrations: `date +%Y%m%d%H%M%S`
3. **Check latest migration** before creating new ones
4. **Self-contained migrations** - Each table has own file with all related code

## Key Database Details
- **ai_models.id**: TEXT PRIMARY KEY (model identifier like 'gpt-4o')
- **ai_models.provider_id**: UUID FK to ai_providers
- **prompt_models.model_id**: TEXT FK to ai_models.id
- **prompts.images**: TEXT[] array (no separate table)
- **RLS**: Enabled on all tables with admin + service_role access
- **Grants**: All tables grant SELECT to anon/authenticated, ALL to service_role

## TypeScript Types
- File: `src/types/database.types.ts` (OUTDATED - has old schema)
- Need to regenerate after migrations stabilize

## Seed Data
- **File**: `supabase/seed.sql`
- **Contains**: 9 AI providers, 15 AI models, 8 root categories with subcategories, 25 tags, 2 sample prompts
- **Note**: All INSERT statements use correct column names (ai_models uses `id`, not `model_id`)

## Additional Migrations (Remote Schema)
- **20251130220020_remote_schema.sql** - Initial remote schema setup (145 bytes)
- **20251130221612_remote_schema.sql** - Large remote schema (77KB)
- **20251130221613_add_service_role_policies.sql** - Service role policies attempt

## Git Status (Last Known)
- Modified: `src/components/ui/button.tsx`, `src/routes/index.tsx`, `src/types/database.types.ts`
- Modified seed.sql and migrations
- Deleted old migrations: `20250121000001_create_prompts_schema.sql`, `20250125000001_add_website_content.sql`
- New directories: `src/assets/`, `src/components/` with new components

## Important Schema Notes
1. **Junction Tables**: `prompt_tags` and `prompt_models` are many-to-many relationships
2. **No UPDATE policies originally** on junction tables (added in 20251201030609)
3. **Admin role check**: `(SELECT auth.jwt() ->> 'role') = 'admin'` - requires JWT claim
4. **Service role**: Uses `current_setting('request.jwt.claims', true)::json->>'role'` or `TO service_role`
5. **Cycle prevention**: Categories have trigger to prevent circular parent references

## Linter Warnings (All Fixed)
- ✅ Function Search Path Mutable - Fixed with `SECURITY DEFINER` and `SET search_path = ''`
- ✅ Auth RLS InitPlan - Fixed with subselects `(SELECT auth.uid())`
- ✅ Multiple Permissive Policies - Fixed by splitting FOR ALL into separate policies

## Working Directory
- Main: `/Users/harryy/Desktop/prompt-valley`
- Migrations: `/Users/harryy/Desktop/prompt-valley/supabase/migrations`
- Platform: macOS (Darwin 25.1.0)

## Pending Tasks
- [ ] Verify Directus access works after 20251201030609 migration
- [ ] Update TypeScript database types to match new schema
- [ ] Test CMS workflow for content team
- [ ] Set up Supabase Storage bucket for logos/images
- [ ] Clean up old remote_schema migrations if not needed

## Commands Reference
```bash
# Apply new migrations
npx supabase db push

# Generate current timestamp for migration
date +%Y%m%d%H%M%S

# Check migration order
ls -la supabase/migrations/ | tail -5

# Check git status
git status

# Drop schema (if needed)
npx supabase db execute "DROP SCHEMA IF EXISTS stripe CASCADE;"
```

## Key Learnings
1. **Never reset database** - User wants incremental migrations only
2. **Always use current timestamp** - Not sequential numbering
3. **Directus pollutes schema** - Moved to separate schema/database
4. **GRANT ALL vs RLS** - Both needed: GRANT for DB access, RLS policies for row-level security
5. **Service role needs explicit policies** - Can't rely on admin JWT checks
